{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">{% if venda %}Editar{% else %}Nova{% endif %} Venda</h4>
                </div>
                <div class="card-body">
                    <form method="post" novalidate id="vendaForm" onsubmit="return validarFormulario()">
                        {% csrf_token %}
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.data.id_for_label }}" class="form-label">Data da Venda</label>
                                {{ form.data }}
                                {% if form.data.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.data.errors }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.data_vencimento.id_for_label }}" class="form-label">Data de Vencimento</label>
                                {{ form.data_vencimento }}
                                {% if form.data_vencimento.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.data_vencimento.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.data_pagamento.id_for_label }}" class="form-label">Data de Pagamento</label>
                                {{ form.data_pagamento }}
                                {% if form.data_pagamento.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.data_pagamento.errors }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.tipo_venda.id_for_label }}" class="form-label">Tipo de Venda</label>
                                {{ form.tipo_venda }}
                                {% if form.tipo_venda.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.tipo_venda.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.valor_unitario.id_for_label }}" class="form-label">Valor Unitário</label>
                                {{ form.valor_unitario }}
                                {% if form.valor_unitario.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.valor_unitario.errors }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.comprador.id_for_label }}" class="form-label">Comprador</label>
                                {{ form.comprador }}
                                {% if form.comprador.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.comprador.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="{{ form.conta_bancaria.id_for_label }}" class="form-label">Conta Bancária</label>
                                {{ form.conta_bancaria }}
                                {% if form.conta_bancaria.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.conta_bancaria.errors }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.numero_parcelas.id_for_label }}" class="form-label">Número de Parcelas</label>
                                {{ form.numero_parcelas }}
                                {% if form.numero_parcelas.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.numero_parcelas.errors }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.intervalo_parcelas.id_for_label }}" class="form-label">Intervalo entre Parcelas</label>
                                {{ form.intervalo_parcelas }}
                                {% if form.intervalo_parcelas.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.intervalo_parcelas.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        {% include 'core/vendas/partials/filtros.html' %}

                        <div class="table-responsive mt-4">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selecionar-todos"></th>
                                        <th>Identificação</th>
                                        <th>Lote</th>
                                        <th>Peso Atual (kg)</th>
                                        <th>Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for animal in animais_disponiveis %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="animal" value="{{ animal.id }}" 
                                                class="animal-checkbox" 
                                                data-peso="{{ animal.get_peso_atual }}"
                                                {% if animal.id|stringformat:"s" in animais_selecionados %}checked{% endif %}>
                                        </td>
                                        <td>{{ animal.brinco_visual }}</td>
                                        <td>{{ animal.lote.id_lote|default:"-" }}</td>
                                        <td>{{ animal.get_peso_atual|default:"-" }}</td>
                                        <td class="valor-animal">R$ 0,00</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4" class="text-end"><strong>Valor Total:</strong></td>
                                        <td id="valor-total">R$ 0,00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="row">
                            <div class="col-md-12 text-end">
                                <a href="{% url 'lista_vendas' %}" class="btn btn-secondary">Cancelar</a>
                                <button type="submit" class="btn btn-primary">Salvar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/vendas/filtros.js' %}"></script>
<script>
    const tipoVendaSelect = document.querySelector('#{{ form.tipo_venda.id_for_label }}');
    const valorUnitarioInput = document.querySelector('#{{ form.valor_unitario.id_for_label }}');
    const checkboxes = document.querySelectorAll('.animal-checkbox');
    const selecionarTodos = document.querySelector('#selecionar-todos');

    // Função para aplicar os filtros
    function aplicarFiltros() {
        const fazendaId = document.getElementById('filtro-fazenda').value;
        const loteId = document.getElementById('filtro-lote').value;
        
        let url = window.location.pathname + '?';
        const params = [];
        
        if (fazendaId) {
            params.push('fazenda=' + fazendaId);
        }
        if (loteId) {
            params.push('lote=' + loteId);
        }
        
        window.location.href = url + params.join('&');
    }

    // Adiciona eventos aos filtros
    document.getElementById('filtro-fazenda').addEventListener('change', aplicarFiltros);
    document.getElementById('filtro-lote').addEventListener('change', aplicarFiltros);

    function formatarMoeda(valor) {
        return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function calcularValorAnimal(checkbox) {
        const peso = parseFloat(checkbox.dataset.peso) || 0;
        const valorUnitario = parseFloat(valorUnitarioInput.value) || 0;
        const tipoVenda = tipoVendaSelect.value;
        
        let valor = 0;
        if (checkbox.checked) {
            if (tipoVenda === 'KG') {
                valor = peso * valorUnitario;
            } else {
                valor = valorUnitario;
            }
        }
        
        // Atualiza o valor na linha da tabela
        const linha = checkbox.closest('tr');
        const tdValor = linha.querySelector('.valor-animal');
        tdValor.textContent = formatarMoeda(valor);
        
        return valor;
    }

    function atualizarValorTotal() {
        let valorTotal = 0;
        checkboxes.forEach(checkbox => {
            valorTotal += calcularValorAnimal(checkbox);
        });
        
        document.querySelector('#valor-total').textContent = formatarMoeda(valorTotal);
    }

    // Event Listeners
    tipoVendaSelect.addEventListener('change', atualizarValorTotal);
    valorUnitarioInput.addEventListener('input', atualizarValorTotal);
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', atualizarValorTotal);
    });
    
    selecionarTodos.addEventListener('change', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        atualizarValorTotal();
    });

    // Atualiza os valores iniciais se houver valores preenchidos
    if (valorUnitarioInput.value) {
        atualizarValorTotal();
    }

    function validarFormulario() {
        console.log('Validando formulário...');
        
        // Verifica se há animais selecionados
        const animaisSelecionados = document.querySelectorAll('.animal-checkbox:checked');
        console.log('Animais selecionados:', Array.from(animaisSelecionados).map(cb => cb.value));
        
        if (animaisSelecionados.length === 0) {
            alert('Selecione pelo menos um animal para a venda.');
            return false;
        }
        
        // Verifica campos obrigatórios
        const form = document.getElementById('vendaForm');
        const data = form.querySelector('#{{ form.data.id_for_label }}').value;
        const valorUnitario = form.querySelector('#{{ form.valor_unitario.id_for_label }}').value;
        const comprador = form.querySelector('#{{ form.comprador.id_for_label }}').value;
        const dataVencimento = form.querySelector('#{{ form.data_vencimento.id_for_label }}').value;
        const tipoPagamento = form.querySelector('#{{ form.tipo_venda.id_for_label }}').value;
        
        console.log('Dados do formulário:', {
            data,
            dataVencimento,
            valorUnitario,
            comprador,
            tipoPagamento,
            animais: Array.from(animaisSelecionados).map(cb => cb.value)
        });
        
        if (!data) {
            alert('A data da venda é obrigatória.');
            return false;
        }
        
        if (!dataVencimento) {
            alert('A data de vencimento é obrigatória.');
            return false;
        }
        
        if (!valorUnitario || valorUnitario <= 0) {
            alert('O valor unitário deve ser maior que zero.');
            return false;
        }
        
        if (!comprador) {
            alert('Selecione um comprador.');
            return false;
        }
        
        console.log('Formulário válido, enviando...');
        return true;
    }
</script>
{% endblock %}
